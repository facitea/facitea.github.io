<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyPage</title>
    <link rel="stylesheet" href="title.css">
    <link rel="stylesheet" href="myPage.css">
    <link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/6.0.1/firebase-ui-auth.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
</head>
<body>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/ui/6.0.1/firebase-ui-auth.js"></script>
    
    <script src="firebase.js"></script>

    <div class="wrapper">
        <header>
            <nav>
                <div class="navLeftSide">
                    <h1><a href="/index.html">Animall</a></h1>
                </div>
                <div class="navRightSide">
                    <ul>
                        <li class="navFlexItem"><a href="/boardList.html">Board</a></li>
                        <li class="navFlexItem"><a href="#">Training</a></li>
                        <li class="navFlexItem"><a href="#">Shop</a></li>
                        <li class="navFlexItem"><a href="#">Trip</a></li>
                        <li class="navFlexItem"><a href="/myPage.html">Me</a></li>
                    </ul>
                </div>
            </nav>
        </header>

        <div class="modalLogIn hidden">
            <div class="modal_overlay"></div>
            <div class="modal_content">
                <div>
                    <input type="email" id="loginEmail" class="loginEmail">
                </div>
                <div>
                    <input type="password" id="loginPwd" class="loginPwd">
                </div>  
                <div>
                    <input type="submit" value="로그인" onclick="submitLogin();">
                    <input type="button" value="회원가입" onclick="submitSignup();">
                </div>
                <div>
                    <a href="#">비밀번호를 잊어버리셨나요?</a>
                    <input type="button" id="closeBtn" value="X">
                </div>
            </div>
            
        </div>

        <div class="profileTap">
            <div class="profileTable">
                <div class="profileFirstStair">
                    <div class="profileImageCircle">
                        <img class="profileImage" src="msk.png" alt="일론머스크">
                    </div>
                </div>
                <div class="profileSecondStair">
                    <div class="relationshipTable">
                        <table>
                            <th>게시물</th>
                            <th>팔로워</th>
                            <th>팔로잉</th>
                            <tr>
                                <td>1</td>
                                <td>1</td>
                                <td>1</td>
                            </tr>
                        </table>
                        <div class="personalToSetting">
                            <div class="personalTable">
                                <div>일론머스크</div>
                                <div>자기소개안해</div>
                            </div>
                            <div class="settingTable">
                                <span class="material-symbols-outlined">
                                    settings
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!--onload를 했을 때에 인증이 되어있으면 내 정보를 보여주고, 
        인증이 되어 있지 않으면 로그인 모달창이 뜨도록 하기
        https://www.youtube.com/watch?v=V08wXKHF_Xw-->

        <input type="button" id="notYetLogin" value="임시버튼.인증=버튼클릭">
    </div>
    <script>
        const notYetLogin = document.getElementById('notYetLogin');
        const modalLogIn = document.querySelector(".modalLogIn");
        const overlay = modalLogIn.querySelector(".modal_overlay");
        const closeBtn = modalLogIn.querySelector("#closeBtn");
        const openModal = () => {
            modalLogIn.classList.remove("hidden");
        }  
        const closeModal = () => {
            modalLogIn.classList.add("hidden");
        }
        overlay.addEventListener("click", closeModal);
        closeBtn.addEventListener("click", closeModal);
        notYetLogin.addEventListener("click", openModal); //addEventListener를 사용해 클릭하면 hidden class(display: none)을 추가하거나 삭제함

        function submitSignup(){
            const email = document.getElementById("loginEmail").value;
            const pwd = document.getElementById("loginPwd").value;

            if (!email || !pwd){
                alert("모든 항목 기재해야합니다");
                return;
            }
            firebase.auth().createUserWithEmailAndPassword(email, pwd)
            .then((userCredential) => {
                // 가입
                var user = userCredential.user;
                alert("가입 성공");
                // ...
            })
            .catch((error) => {
                var errorCode = error.code;
                var errorMessage = error.message;
                consolo.log("가입 실패");
                // 제주도 여행가기전에 급하게 구현하는거니까 로그인폼에 회원가입시켜보자
            });
        }

        function submitLogin(){
            const email = document.getElementById("loginEmail").value;
            const pwd = document.getElementById("loginPwd").value;


            if (!email || !pwd){
                alert("모든 항목 기재해야합니다");
                return;
            }
            firebase.auth().signInWithEmailAndPassword(email, pwd)
            .then((userCredential) => {
                // 로그인
                var user = userCredential.user;

                firebase.auth().onAuthStateChanged((user) => {
                    sessionStorage.setItem("mySession", user.uid);
                    console.log(user.uid);
                }); //로그인을 하면 uid정보를 mySession세션 key값에 저장하는 함수.
            
                /*
                //페이지를 불러올 때마다 세션 확인을 하는 건 너무 원시적이지 않나
                세션확인 방법을 알아보자
                */

                alert("로그인 성공");
                // ...
            })
            .catch((error) => {
                var errorCode = error.code;
                var errorMessage = error.message;
                console.log("로그인 실패");
            });

        }
        //회원가입을 하면 그대로 로그인이 되게 만들자. 이건 쉽다.

        
            firebase.auth().setPersistence(firebase.auth.Auth.Persistence.SESSION)
            .then(() => {
                return firebase.auth().signInWithEmailAndPassword(email, pwd);
                alert("로그인 유지 중");
            })
            .catch((error) => {
                var errorCode = error.code;
                var errorMessage = error.message;
                alert("로그인이 필요합니다.");
            })//오류가 있다. 이 코드는 로그인을 검증하는 코드로 추정되나, 아직 작동하지 않는다. 아마도 로그인시 세선에 id값을 넘겨주고 onload시 그 세션과 비교하여 맞다면 계속 진행하게 만들어야하지않나 싶다.
            //sessionStorage.setItem("MY_SESSION", "here"); 세션을 설정하고 가져오는 작업이 필요

        
    </script>
</body>
</html>