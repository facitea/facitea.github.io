<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BoardList</title>
    <link rel="stylesheet" href="title.css">
    <link rel="stylesheet" href="boardList.css">
    <link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/6.0.1/firebase-ui-auth.css" />
</head>

<body>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/ui/6.0.1/firebase-ui-auth.js"></script>

    <script src="firebase.js"></script>
    <script src="auth.js"></script>
    <div class="wrapper">
        <header>
            <nav>
                <div class="navLeftSide">
                    <h1><a href="./index.html">Animall</a></h1>
                </div>
                <div class="navRightSide">
                    <ul>
                        <li class="navFlexItem"><a href="./boardList.html">Board</a></li>
                        <li class="navFlexItem"><a href="./index.html">Training</a></li>
                        <li class="navFlexItem"><a href="./index.html">Shop</a></li>
                        <li class="navFlexItem"><a href="./index.html">Trip</a></li>
                        <li class="navFlexItem"><a href="./myPage.html">Me</a></li>
                    </ul>
                </div>
            </nav>
        </header>

        <aside class="leftAside">
            
        </aside>

        <div class="feedWrapper" id="feedWrapper">
            <div class="feedContentBox">
                <div class="feedHeader">
                    <div class="headerLeft">
                        <div class="profileImageCircle">
                            <img class="profileImage" src="msk.png" alt="일론머스크">
                        </div>
                        <div class="userNickname" id="userNickname0">닉네임</div>
                    </div>

                    <div>
                        <div class="feedSetting">설정</div>
                    </div>
                </div>

                <div class="feedImage">
                    <img id="feedImage0" alt="메인사진">
                </div>

                <div class="feedInteraction">
                    <div class="feedInteractionDetail">
                        <div class="iLikeIt">좋아요</div>
                        <div class="wrtComment">댓글</div>
                        <div class="sendToMsg">메시지</div>
                    </div>

                    <div>
                        <div class="bookmark">저장</div>
                    </div>
                </div>

                <div class="interactionStatus">
                    <div class="howManyLikey">좋아요 n개</div>
                </div>

                <div>
                    <div class="feedText" id="feedText0">게시글내용</div>
                </div>
                <div>
                    <div class="createdDate" id="createdDate0">날짜</div>
                </div>
            </div>

            <div class="feedContentBox">
                <div class="feedHeader">
                    <div class="headerLeft">
                        <div class="profileImageCircle">
                            <img class="profileImage" src="msk.png" alt="일론머스크">
                        </div>
                        <div class="userNickname" id="userNickname1">닉네임</div>
                    </div>

                    <div>
                        <div class="feedSetting">설정</div>
                    </div>
                </div>

                <div class="feedImage">
                    <img id="feedImage1" alt="메인사진">
                </div>

                <div class="feedInteraction">
                    <div class="feedInteractionDetail">
                        <div class="iLikeIt">좋아요</div>
                        <div class="wrtComment">댓글</div>
                        <div class="sendToMsg">메시지</div>
                    </div>

                    <div>
                        <div class="bookmark">저장</div>
                    </div>
                </div>

                <div class="interactionStatus">
                    <div class="howManyLikey">좋아요 n개</div>
                </div>

                <div>
                    <div class="feedText" id="feedText1">게시글내용</div>
                </div>
                <div>
                    <div class="createdDate" id="createdDate1">날짜</div>
                </div>
            </div>

            <div class="feedContentBox">
                <div class="feedHeader">
                    <div class="headerLeft">
                        <div class="profileImageCircle">
                            <img class="profileImage" src="msk.png" alt="일론머스크">
                        </div>
                        <div class="userNickname" id="userNickname2">닉네임</div>
                    </div>

                    <div>
                        <div class="feedSetting">설정</div>
                    </div>
                </div>

                <div class="feedImage">
                    <img id="feedImage2" alt="메인사진">
                </div>

                <div class="feedInteraction">
                    <div class="feedInteractionDetail">
                        <div class="iLikeIt">좋아요</div>
                        <div class="wrtComment">댓글</div>
                        <div class="sendToMsg">메시지</div>
                    </div>

                    <div>
                        <div class="bookmark">저장</div>
                    </div>
                </div>

                <div class="interactionStatus">
                    <div class="howManyLikey">좋아요 n개</div>
                </div>

                <div>
                    <div class="feedText" id="feedText2">게시글내용</div>
                </div>
                <div>
                    <div class="createdDate" id="createdDate2">날짜</div>
                </div>
            </div>

            <div class="feedContentBox">
                <div class="feedHeader">
                    <div class="headerLeft">
                        <div class="profileImageCircle">
                            <img class="profileImage" src="msk.png" alt="일론머스크">
                        </div>
                        <div class="userNickname" id="userNickname3">닉네임</div>
                    </div>

                    <div>
                        <div class="feedSetting">설정</div>
                    </div>
                </div>

                <div class="feedImage">
                    <img id="feedImage3" alt="메인사진">
                </div>

                <div class="feedInteraction">
                    <div class="feedInteractionDetail">
                        <div class="iLikeIt">좋아요</div>
                        <div class="wrtComment">댓글</div>
                        <div class="sendToMsg">메시지</div>
                    </div>

                    <div>
                        <div class="bookmark">저장</div>
                    </div>
                </div>

                <div class="interactionStatus">
                    <div class="howManyLikey">좋아요 n개</div>
                </div>

                <div>
                    <div class="feedText" id="feedText3">게시글내용</div>
                </div>
                <div>
                    <div class="createdDate" id="createdDate3">날짜</div>
                </div>
            </div>

            <div class="feedContentBox">
                <div class="feedHeader">
                    <div class="headerLeft">
                        <div class="profileImageCircle">
                            <img class="profileImage" src="msk.png" alt="일론머스크">
                        </div>
                        <div class="userNickname" id="userNickname4">닉네임</div>
                    </div>

                    <div>
                        <div class="feedSetting">설정</div>
                    </div>
                </div>

                <div class="feedImage">
                    <img id="feedImage4" alt="메인사진">
                </div>

                <div class="feedInteraction">
                    <div class="feedInteractionDetail">
                        <div class="iLikeIt">좋아요</div>
                        <div class="wrtComment">댓글</div>
                        <div class="sendToMsg">메시지</div>
                    </div>

                    <div>
                        <div class="bookmark">저장</div>
                    </div>
                </div>

                <div class="interactionStatus">
                    <div class="howManyLikey">좋아요 n개</div>
                </div>

                <div>
                    <div class="feedText" id="feedText4">게시글내용</div>
                </div>
                <div>
                    <div class="createdDate" id="createdDate4">날짜</div>
                </div>
            </div>

            <div id="newSection0"></div>

            <input type="button" onclick="moreFeedLoad()" value="게시글 가져오기">

            
        </div>

        <aside class="rightAside">
                
        </aside>
        

        <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
        <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
        <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
        <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
        <script src="firebase.js"></script>
        <script src="auth.js"></script>
        <script>
            //doc.data(); 원시적인 데이터인듯

            var list = [];//게시글을 배열에 담는다

            /*★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★
            db.collection('게시판').orderBy("timeStamp", "desc").limit(100).get().then((결과)=>
                {
                결과.forEach((doc)=>{
                    console.log(doc.data());
                    list.push(doc.data());
                })            
            }) //예를 들어 알파벳순으로 처음 n개 항목을 쿼리하는 방법은 다음과 같습니다. 내림차순으로 정렬은 , orderBy("timeStamp", "desc")
            ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★
            */

            /*
            db.collection('게시판').orderBy("id", "desc").startAt(20221102000000).get().then((결과)=>
                {
                결과.forEach((doc)=>{
                    console.log(doc.data());
                    list.push(doc.data());
                })            
            })
    
            db.collection('게시판').where("timeStamp", "<", "2022-10-25 00:00:00")
            .where("timeStamp", ">", "2022-10-01 00:00:00")
            .get().then((결과)=>
                {
                결과.forEach((doc)=>{
                    console.log(doc.data());
                    list.push(doc.data());
                })            
            }) 이거다. 기만만큼만 정보를 뽑을 수 있다.
            */

            /*
            db.collection('게시판')
            .where("timeStamp", ">", "2022-10-09 00:00:00")
            .where("timeStamp", "<=", "2022-10-10 00:00:00")
            .get().then((결과)=>
                {
                결과.forEach((doc)=>{
                    console.log(doc.data());
                    list.push(doc.data());
                })            
            })
            이 날짜를 동적으로 

                https://7942yongdae.tistory.com/40
            */

            const getYmd10 = () => {
                var d = new Date();
                return d.getFullYear() + ((d.getMonth() + 1) > 9 ? (d.getMonth() + 1).toString() : (d.getMonth() + 1)) + (d.getDate() > 9 ? d.getDate().toString() : "0" + d.getDate().toString());
            }//YYYYMMDD

            //startAt() 또는 startAfter() 메서드를 사용하여 쿼리의 시작점을 정의합니다.

            /*★22/12/15주석처리
            startAt, endAt은 기준점을 뺀 나머지를 보여준다. startAfter(1)는 뭐가 다른지 모르겠다.
            */

            var lastfeedId;
            const lastFeedIdCheck = async () => {
                await db.collection('게시판').orderBy("timeStamp", "desc").limit(1).get().then((결과) => {
                    결과.forEach((doc) => {
                        const lastIdCheck = doc.data();//document의 내용물 = doc.data();
                        const lastId = parseInt(lastIdCheck.feedId);//DB에 있는 내가 임의로 지정한 id값은 feedId인데, 그 document의 feedid를 lastId에 담는다는 뜻
                        lastfeedId = parseInt(lastId);
                    })
                })//함수로 감싸버리기
            }

            const recentFiveFeedData = async () => {
                await db.collection('게시판').orderBy("feedId", "desc").where("feedId", "<=", lastfeedId)
                    .limit(5)
                    .get().then((result) => {
                        result.forEach((doc) => {
                            list.push(doc.data());
                        })
                    })
            }

            const getFeedData = async () => {
                await lastFeedIdCheck();
                await recentFiveFeedData();

                const userNickname = 'userNickname';
                const feedText = 'feedText';
                const createdDate = 'createdDate';

                for (let i = 0; i < 5; i++){
                    document.getElementById(userNickname + i).innerHTML = list[i].writerNickname;
                    document.getElementById(feedText + i).innerHTML = list[i].content;
                    document.getElementById(createdDate + i).innerHTML = list[i].timeStamp;
                }

                var feedImageNum;
                var idStringFinal;
                var img;
                var imageLinkArr = [];
                var j;
                var fullFeedImageUrl = [];//함수 내 전역변수

                //반복문내에서 함수를 돌리기 전에 변수를 지정해서  list[i].imagelink 값을 넣어서 함수에 넣기

                const getFullFeedImageUrl = async () => {
                    for (let i = 0; i < 5; i++) {
                        imageLinkArr.push(list[i].imagelink);
                    }

                    for (let i = 0; i < 5; i++) {
                        j = imageLinkArr[i];//각 간략화된 주소를 j에 담는다.->j를 child의 매개변수로 넣는다.

                        await storageRef.child(j).getDownloadURL()
                            .then((url) => {
                                // Or inserted into an <img> element ->이 방법으로 써야한다.

                                fullFeedImageUrl.push(url);//firebase 메소드를 통해 fullFeedImageUrl에 풀 주소를 담았다.
                            })
                            .catch((error) => {
                                console.log("이미지를 불러오는 중 오류가 발생했습니다.")
                                // Handle any errors
                            }); //이미지를 해당 id dom에 그려준다
                        //사진꺼내오는법
                        //위 코드는 html요소에 src를 넣는 것이기 때문에 img태그로 바꾸면 해결된다.
                    }
                }

                const setFirstLoadFeedImage = async () => {//이 함수에서 id값으로 array값을 src요소로 입힌다.
                    for (let i = 0; i < 5; i++) {
                        feedImageNum = i;
                        idStringFinal = String("feedImage" + feedImageNum);
                        img = document.getElementById(idStringFinal);
                        img.setAttribute('src', fullFeedImageUrl[i]);
                    }


                }

                const FirstLoadFeedImageRun = async () => {
                    await getFullFeedImageUrl();
                    setFirstLoadFeedImage();
                }

                FirstLoadFeedImageRun();

                //img태그에 id값까지는 잘 뿌려주는데 이미지를 못올린다.
                //만약 서버에서 image가 없어서 오류가 나는 거라면 
                //업로드 시 사진이 없을 때에 자동으로 해당 값을 뽀리 사진 link로 불러오게 하자.
                //일단 일이 너무 커지니 DB초기화는 다음에 하도록 하자.
                //image가 없거나 사진이 아니면 못올리게 하는 로직구현이 내일 할 것.
                //너무 많은 JS연산이 있어도 제대로 돌아가지 않는 것 같다.

                list = [];
            }

            getFeedData();//첫 로딩만 이걸로 시행

            var sectionCount = 0;
            var sectionCountName = 'newSection';
            var sectionCountId;

            var moreSectionCount = 5;//전역변수로 5번 index부터 새로운 글의 id가 정해진다는 걸 보여줌.

            const moreFeedLoad = () => {// moreContent 위에 백틱 코드가 생성된다.
                sectionCountId = String('newSection' + sectionCount);
                document.getElementById(sectionCountId).innerHTML = `
            <div class="feedContentBox">
                <div class="feedHeader">
                    <div class="headerLeft">
                    <div class="profileImageCircle">
                        <img class="profileImage" src="msk.png" alt="일론머스크">
                    </div>
                    <div class="userNickname" id="userNickname${moreSectionCount}">닉네임</div>
                    </div>
                    
                    <div>
                    <div class="feedSetting">설정</div>
                    </div>
                </div>
                
                <div class="feedImage">
                    <img id="feedImage${moreSectionCount}" alt="메인사진">
                </div>
                
                <div class="feedInteraction">
                    <div class="feedInteractionDetail">
                    <div class="iLikeIt">좋아요</div>
                    <div class="wrtComment">댓글</div>
                    <div class="sendToMsg">메시지</div>
                    </div>
                    
                    <div>
                    <div class="bookmark">저장</div>
                    </div>
                </div>
                
                <div class="interactionStatus">
                    <div class="howManyLikey">좋아요 n개</div>
                </div>
                
                <div>
                    <div class="feedText" id="feedText${moreSectionCount}">게시글내용</div>
                </div>
                <div>
                    <div class="createdDate" id="createdDate${moreSectionCount}">날짜</div>
                </div>
            </div>

            <div class="feedContentBox">
                <div class="feedHeader">
                    <div class="headerLeft">
                    <div class="profileImageCircle">
                        <img class="profileImage" src="msk.png" alt="일론머스크">
                    </div>
                    <div class="userNickname" id="userNickname${moreSectionCount + 1}">닉네임</div>
                    </div>
                    
                    <div>
                    <div class="feedSetting">설정</div>
                    </div>
                </div>
                
                <div class="feedImage">
                    <img id="feedImage${moreSectionCount + 1}" alt="메인사진">
                </div>
                
                <div class="feedInteraction">
                    <div class="feedInteractionDetail">
                    <div class="iLikeIt">좋아요</div>
                    <div class="wrtComment">댓글</div>
                    <div class="sendToMsg">메시지</div>
                    </div>
                    
                    <div>
                    <div class="bookmark">저장</div>
                    </div>
                </div>
                
                <div class="interactionStatus">
                    <div class="howManyLikey">좋아요 n개</div>
                </div>
                
                <div>
                    <div class="feedText" id="feedText${moreSectionCount + 1}">게시글내용</div>
                </div>
                <div>
                    <div class="createdDate" id="createdDate${moreSectionCount + 1}">날짜</div>
                </div>
            </div>

            <div class="feedContentBox">
                <div class="feedHeader">
                    <div class="headerLeft">
                    <div class="profileImageCircle">
                        <img class="profileImage" src="msk.png" alt="일론머스크">
                    </div>
                    <div class="userNickname" id="userNickname${moreSectionCount + 2}">닉네임</div>
                    </div>
                    
                    <div>
                    <div class="feedSetting">설정</div>
                    </div>
                </div>
                
                <div class="feedImage">
                    <img id="feedImage${moreSectionCount + 2}" alt="메인사진">
                </div>
                
                <div class="feedInteraction">
                    <div class="feedInteractionDetail">
                    <div class="iLikeIt">좋아요</div>
                    <div class="wrtComment">댓글</div>
                    <div class="sendToMsg">메시지</div>
                    </div>
                    
                    <div>
                    <div class="bookmark">저장</div>
                    </div>
                </div>
                
                <div class="interactionStatus">
                    <div class="howManyLikey">좋아요 n개</div>
                </div>
                
                <div>
                    <div class="feedText" id="feedText${moreSectionCount + 2}">게시글내용</div>
                </div>
                <div>
                    <div class="createdDate" id="createdDate${moreSectionCount + 2}">날짜</div>
                </div>
            </div>

            <div class="feedContentBox">
                <div class="feedHeader">
                    <div class="headerLeft">
                    <div class="profileImageCircle">
                        <img class="profileImage" src="msk.png" alt="일론머스크">
                    </div>
                    <div class="userNickname" id="userNickname${moreSectionCount + 3}">닉네임</div>
                    </div>
                    
                    <div>
                    <div class="feedSetting">설정</div>
                    </div>
                </div>
                
                <div class="feedImage">
                    <img id="feedImage${moreSectionCount + 3}" alt="메인사진">
                </div>
                
                <div class="feedInteraction">
                    <div class="feedInteractionDetail">
                    <div class="iLikeIt">좋아요</div>
                    <div class="wrtComment">댓글</div>
                    <div class="sendToMsg">메시지</div>
                    </div>
                    
                    <div>
                    <div class="bookmark">저장</div>
                    </div>
                </div>
                
                <div class="interactionStatus">
                    <div class="howManyLikey">좋아요 n개</div>
                </div>
                
                <div>
                    <div class="feedText" id="feedText${moreSectionCount + 3}">게시글내용</div>
                </div>
                <div>
                    <div class="createdDate" id="createdDate${moreSectionCount + 3}">날짜</div>
                </div>
            </div>

            <div class="feedContentBox">
                <div class="feedHeader">
                    <div class="headerLeft">
                    <div class="profileImageCircle">
                        <img class="profileImage" src="msk.png" alt="일론머스크">
                    </div>
                    <div class="userNickname" id="userNickname${moreSectionCount + 4}">닉네임</div>
                    </div>
                    
                    <div>
                    <div class="feedSetting">설정</div>
                    </div>
                </div>
                
                <div class="feedImage">
                    <img id="feedImage${moreSectionCount + 4}" alt="메인사진">
                </div>
                
                <div class="feedInteraction">
                    <div class="feedInteractionDetail">
                    <div class="iLikeIt">좋아요</div>
                    <div class="wrtComment">댓글</div>
                    <div class="sendToMsg">메시지</div>
                    </div>
                    
                    <div>
                    <div class="bookmark">저장</div>
                    </div>
                </div>
                
                <div class="interactionStatus">
                    <div class="howManyLikey">좋아요 n개</div>
                </div>
                
                <div>
                    <div class="feedText" id="feedText${moreSectionCount + 4}">게시글내용</div>
                </div>
                <div>
                    <div class="createdDate" id="createdDate${moreSectionCount + 4}">날짜</div>
                </div>
            </div>

            <div id="${sectionCountName + parseInt(sectionCount + 1)}"></div>
            `


                const loadNextFiveFeedData = async () => {
                    await db.collection('게시판').orderBy("feedId", "desc").where("feedId", "<=", lastfeedId)
                        .limit(5)
                        .get().then((result) => {
                            result.forEach((doc) => {
                                list.push(doc.data());
                            })
                        })
                }

                const getNextFeedData = async () => {
                    lastfeedId = parseInt(lastfeedId - 5);
                    const userNickname = "userNickname";
                    const feedText = "feedText";
                    const createdDate = "createdDate";

                    await recentFiveFeedData();
                    console.log(list);

                    for(let i=0; i < 5; i++){
                        document.getElementById(userNickname + (moreSectionCount + i)).innerHTML = list[i].writerNickname;
                        document.getElementById(feedText + (moreSectionCount + i)).innerHTML = list[i].content;
                        document.getElementById(createdDate + (moreSectionCount + i)).innerHTML = list[i].timeStamp;
                    }

                }
                //6~10번째 자료를 가져오려면 getNextFeedData() 메소드를 통해 가져온 data를 array에 담아
                //자료가 보여줄 만큼 충분히 있으면, 동적으로 HTML을 생성해
                //자료를 HTML에 보여주면 되겠다. 



                var feedImageNum;
                var idStringFinal;
                var img;
                var imageLinkArr = [];
                var j;
                var fullFeedImageUrl = [];



                //반복문내에서 함수를 돌리기 전에 변수를 지정해서  list[i].imagelink 값을 넣어서 함수에 넣기

                const getFullFeedImageUrl = async () => {
                    for (i = 0; i < 5; i++) {
                        imageLinkArr.push(list[i].imagelink);
                    }

                    for (i = 0; i < 5; i++) {
                        j = imageLinkArr[i];//각 간략화된 주소를 j에 담는다.->j를 child의 매개변수로 넣는다.

                        await storageRef.child(j).getDownloadURL()
                            .then((url) => {
                                // Or inserted into an <img> element ->이 방법으로 써야한다.

                                fullFeedImageUrl.push(url);//firebase 메소드를 통해 fullFeedImageUrl에 풀 주소를 담았다.
                            })
                            .catch((error) => {
                                console.log("이미지를 불러오는 중 오류가 발생했습니다.")
                                // Handle any errors
                            }); //이미지를 해당 id dom에 그려준다
                        //사진꺼내오는법
                        //위 코드는 html요소에 src를 넣는 것이기 때문에 img태그로 바꾸면 해결된다.
                    }
                }

                async function setFirstLoadFeedImage() {
                    for (i = 0; i < 5; i++) {
                        let a = moreSectionCount + i;
                        idStringFinal = String("feedImage" + a);//id값을 동적으로 생성
                        img = document.getElementById(idStringFinal);
                        img.setAttribute('src', fullFeedImageUrl[i]);
                    }
                }

                const FirstLoadFeedImageRun = async () => {
                    await getFullFeedImageUrl();
                    setFirstLoadFeedImage();
                }


                const showNextFeedData = async () => {
                    await getNextFeedData();
                    await FirstLoadFeedImageRun();
                    list = [];
                    sectionCount = sectionCount + 1;
                    // 내 능력의 한계로 새로운 게시글은 0 자식요소 1 자식요소 2 자식요소 3 같은 계단식으로 구성했다.
                    //sectionCount Name Id 등은 이를 표현하기 위한 변수이다.
                    moreSectionCount = moreSectionCount + 5;
                }

                showNextFeedData();

            }
        </script>
</body>

</html>
